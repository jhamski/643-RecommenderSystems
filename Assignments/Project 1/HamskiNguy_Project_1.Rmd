---
title: "Project 1 - Basic Recommender System"
author: "J. Hamski, V. Nguy"
date: "June 12, 2016"
output: html_document
---

```{r load_libraries, warning = FALSE, error = FALSE, message=FALSE}
library(recommenderlab)
library(Matrix)
library(dplyr)
library(tidyr)
library(ggplot2)

options(scipen=999)
```

# Description
Using Last.fm data we will build a simple recommender system that will recommend music to the users. We will be building this recommender system using collaborative filtering. The system will use an Item-based collaborative filter to recommend music to the users.

[Dataset information](http://files.grouplens.org/datasets/hetrec2011/hetrec2011-lastfm-readme.txt)

# Dataset
[Last.FM](http://grouplens.org/datasets/hetrec-2011/) data from grouplens.org. The dataset we are interested in is the 'user_artists.dat' data file. This file contains the artists listened by each user. It also provides a listening count for each [user, artist] pair.  

Reading in needed datasets. Artist information will be joined to user-artist dataset for readability
```{r Read_Dataset, cache=TRUE}
user.artists.pairwise <- read.delim('hetrec2011-lastfm-2k/user_artists.dat', sep="\t")

artists <- read.delim('hetrec2011-lastfm-2k/artists.dat', sep="\t") %>%
  select(id, name)
```

#Data Preparation

Converting from Artist IDs to Artist Names for easier interpretation
```{r join_artist_name, cache=TRUE}
colnames(artists) <- c("artistID", "name")

#note: one duplicate artist
#artists$name[duplicated(artists$name)==TRUE]
user.artists.pairwise <- inner_join(user.artists.pairwise, artists, by="artistID")

user.artists.pairwise <- select(user.artists.pairwise, -artistID)

user.artists.pairwise[16060,]$name <- NA

ggplot(user.artists.pairwise, aes(x = weight)) + geom_density() + theme_bw() + scale_x_log10()
```

Using the TidyR library. The pairwise data was converted into a sparse matrix.
```{r spread_data, cache=TRUE}
num_listens <- 1000

user.artists.matrix <- user.artists.pairwise %>%
  filter(weight > num_listens) %>% #filter artists with less than num_listens listens
  spread(key = name, value = weight) %>%
  as.matrix()

user.artists <- user.artists.matrix[,-1]
dim(user.artists)
```


For development, work with a smaller matrix. Set eval = FALSE for final rendering. 
```{r, eval=TRUE, , cache=TRUE}
#note - perhaps this should select randomly instead of the first 1000 rows / 500 columns?
#user.artists <- user.artists[1:200, 1:500]

user.artists.colSums <- colSums(user.artists, na.rm=TRUE)

summary(user.artists.colSums)
```


# Calculating Similarity using the 'recommenderlab' package
```{r reclab_sim_matrix, cache=TRUE}
#note this is takes a few minutes to compute
user.artists.RRM <- new("realRatingMatrix", data = as(user.artists, "CsparseMatrix"))

#reclab.similarity.user <- similarity(user.artists.RRM, method = "cosine", which = "users")
reclab.similarity.item <- similarity(user.artists.RRM, method = "cosine", which = "items")

reclab.sim.item.matrix <- as.matrix(reclab.similarity.item)
```

```{r sim_matrix, cache=TRUE}
#image(as.matrix(reclab.similarity.user))
image(reclab.sim.item.matrix)
```

```{r reclab_recommendations_1, cache=TRUE}
#Old-school hiphop band A Tribe Called Quest's similar listens
ATribeCalledQuest.sim.row <- reclab.sim.item.matrix["Beach House",]

ATribeCalledQuest.similar.listens <- ATribeCalledQuest.sim.row[complete.cases(ATribeCalledQuest.sim.row)]

#Several similar artists - De La Soul, Beck, Sade are in the same genre
sort(ATribeCalledQuest.similar.listens, decreasing = TRUE)[1:20]
```

```{r artist_recommendations_2}
#Old-school hiphop band A Tribe Called Quest's similar listens
ATribeCalledQuest.sim.row <- reclab.sim.item.matrix["Nine Inch Nails",]

ATribeCalledQuest.similar.listens <- ATribeCalledQuest.sim.row[complete.cases(ATribeCalledQuest.sim.row)]

#Several similar artists - De La Soul, Beck, Sade are in the same genre
sort(ATribeCalledQuest.similar.listens, decreasing = TRUE)[1:20]
```

# Calculating Similiarity using built-in Matrix Algebra Functions

```{r, eval=FALSE}

cosineDist <- function(x){
  as.dist(1 - x%*%t(x)/(sqrt(rowSums(x^2) %*% t(rowSums(x^2))))) 
}

cosineDist(user.artists)

image(as.matrix(user.artists))
```

# Calculate Similarity using our own Cosine Distance Algorithm 
```{r custom_similarity_function}
euc_distance <- function(x) {
  return (sqrt(sum(x^2,na.rm=TRUE)))
}

cos_sim_matrix <- function(x) {
  # initialize similarity matrix
  m <- matrix(NA, nrow=ncol(x),ncol=ncol(x),dimnames=list(colnames(x),colnames(x)))
  similarity <- as.data.frame(m)
  
  for(i in 1:ncol(x)) {
    for(j in i:ncol(x)) {
      #Take only the columns in which both users ranked the item
      co_rate_1 <- x[which(x[,i] & x[,j]),i]
      co_rate_2 <- x[which(x[,i] & x[,j]),j]  
      #Calculate the Cosine Similarity
      similarity[i,j]= sum(co_rate_1*co_rate_2) / (euc_distance(x[,i]) * euc_distance(x[,j]))
      #Replicate results for the 'other half' of the matrix
      similarity[j,i]=similarity[i,j]        
    }
  }
  return(similarity)
}
```


```{r, eval=F}
#Test case to validate results. Using toy dataset from meetup. Set to false before final rendering.
movie <- read.csv('UBCF.csv', header = TRUE, stringsAsFactors = FALSE)
rownames(movie) <- movie[,1]
movie <- movie[,-1]

#Results should match Item-Item CF tab
cos_sim_matrix(movie)

#Results should match User-User CF tab
cos_sim_matrix(t(movie))
```

```{r custom_sim_matrix, warning=FALSE}
#Results should match Item-Item CF tab
custom.similarity.item <- cos_sim_matrix(user.artists)

#Results should match User-User CF tab
#custom.similarity.user <- cos_sim_matrix(t(user.artists))
```

```{r custom_artist_recommendations_1}
recommendation.custom <- custom.similarity.item["Beach House",]
recommendation.custom <- as.matrix(t(recommendation.custom))

#Remove records with no score
recommendation.custom <- recommendation.custom[!(apply(recommendation.custom, 1, function(y) any(y == 0))),]

#Remove 'identity recommendation'
recommendation.custom <- recommendation.custom[recommendation.custom<0.99]

sort(recommendation.custom, decreasing = TRUE)
```

```{r custom_artist_recommendations_2}
recommendation.custom <- custom.similarity.item["Nine Inch Nails",]
recommendation.custom <- as.matrix(t(recommendation.custom))

#Remove records with no score
recommendation.custom <- recommendation.custom[!(apply(recommendation.custom, 1, function(y) any(y == 0))),]

#Remove 'identity recommendation'
recommendation.custom <- recommendation.custom[recommendation.custom<0.99]

sort(recommendation.custom, decreasing = TRUE)
```
