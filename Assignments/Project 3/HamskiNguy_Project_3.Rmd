---
title: 'Recommender Systems - Project #3'
author: "J. Hamski, V. Nguy"
date: "June 28, 2016"
output: html_document
---


```{r, warning=FALSE, message=FALSE, cache=TRUE}
require(shiny)
require(dplyr)
require(ggplot2)
require(tidyr)
require(knitr)
#require(Matrix)
require(recommenderlab)

options(scipen=999)
```

Reading in needed datasets. Artist information will be joined to user-artist dataset for readability
```{r Read_Dataset, cache=TRUE, warnings = FALSE}
user.artists.pairwise <- read.delim('hetrec2011-lastfm-2k/user_artists.dat', sep="\t")

artists <- read.delim('hetrec2011-lastfm-2k/artists.dat', sep="\t") %>%
  select(id, name)
```

#Data Preparation

Converting from Artist IDs to Artist Names for easier interpretation.
```{r join_artist_name, cache=TRUE}
colnames(artists) <- c("artistID", "name")

#note: one duplicate artist
#artists$name[duplicated(artists$name)==TRUE]
user.artists.pairwise <- inner_join(user.artists.pairwise, artists, by="artistID")
user.artists.pairwise <- select(user.artists.pairwise, -artistID)
user.artists.pairwise$name <- strtrim(user.artists.pairwise$name, 100)
user.artists.pairwise[16060,]$name <- NA

#ggplot(user.artists.pairwise, aes(x = weight)) + geom_density() + theme_bw() + scale_x_log10()
```

```{r, cache=TRUE}
num_listens = 1000

user.artists <- user.artists.pairwise %>%
  filter(weight > num_listens) %>% #filter artists with less than num_listens listens
  spread(key = name, value = weight) %>%
  as.matrix()

user.artists <- user.artists[,-1]
dim(user.artists)
```

From this we note that n = 1416 (users) and m = 2776 (artists).

Replace NAs with zeros and scale.
```{r}
user.artists[is.na(user.artists)] <- 0
user.artists <- scale(user.artists, center = TRUE, scale = TRUE)
user.artists[is.nan(user.artists)] <- 0
```

Built-in SVD function. 
```{r}
svd <- svd(user.artists)
summary(svd)
```

```{r}
dim(svd$u)
dim(svd$v)
```

Reduce the vector d to values greater than 1 and use it to create a matrix k. 
```{r}
score.limit <- 1
k <- svd$d[svd$d >= score.limit]
k.length <- length(k)
s <- k %>%
  sqrt() %>%
  diag()

dim(s)
```


```{r}
#This matrix should be m x k.
u.reduced <- svd$u[,1:k.length,]
dim(u.reduced)

#This matrix should be k x n.

v.reduced <- svd$v[,1:k.length]
dim(v.reduced)
```

```{r}
predicted <- v.reduced %*% s %*% u.reduced
dim(predicted)
```

```{r}
colnames(predicted) <- rownames(user.artists)
rownames(predicted) <- colnames(user.artists)
```

Let's say I listen to: Jay-Z and Nas. What users am I most similar to?

```{r}
artists <- colnames(user.artists)
n.tags <- length(artists)

query.vector <- rep(0, n.tags)
query.vector[which(artists == "Nas")] <- 1
query.vector[which(artists == "Jay-Z")] <- 1
```

```{r}
recommendation <- query.vector %*% predicted
users <- rownames(user.artists)
recommendation.table <- as.data.frame(cbind(users, recommendation[1,]))

similar.users <- arrange(recommendation.table, desc(V2))
```

```{r}
head(similar.users)
```

Now, we take a look at the artists user 871 listened to. 
```{r}
user.871 <- user.artists[871,]

user.871 <- cbind(artists, user.871) %>% as.data.frame() %>% arrange(desc(user.871))
head(user.871)
```

Unfortunately, we don't see rap artists, which is what we would anticipate. 

However, when we check similar user ranked #6, we get DMX, T.I. and Bizzy Bone - all rappers and good recommendations for our hypothetical listener. 
```{r}
user.1216 <- user.artists[1216,]

user.1216 <- cbind(artists, user.1216) %>% as.data.frame() %>% arrange(desc(user.1216))
head(user.1216)
```






```{r}
svd$d[51:length(svd$d)] <- 0

#UDVT
user.artists.svd <- svd$u %*% diag(svd$d) %*% t(svd$v)
dim(user.artists.svd)
```


```{r}
user.artists.RRM <- as(user.artists.svd,"realRatingMatrix")
user.ratings <- user.artists.RRM[rowCounts(user.artists.RRM) > 45, colCounts(user.artists.RRM) > 50]

#dim(user.ratings)

#user.ratings.norm <- normalize(user.ratings)

#sum(rowMeans(user.ratings.norm) > 0.00001)
```

```{r}
training <- sample(x=c(TRUE, FALSE), size=nrow(user.ratings), replace=TRUE, prob=(c(0.8,0.2)))
rating.train <- user.ratings[training,]
rating.test <- user.ratings[!training,]
```

```{r}
rec.model <- Recommender(data=rating.train, method="IBCF", parameter = list(k=5))
```

```{r}
rec.predict <- predict(object=rec.model, newdata=rating.test, n=5)
rec.predict@items[6]

rec_1 <- rec.predict@items[[1]]
artist.predict <- rec.predict@itemLabels[rec_1]
artist.predict
```
